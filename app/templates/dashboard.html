<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MoMo SMS Dashboard</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{box-sizing:border-box;}
body{margin:0;font-family:'Inter',sans-serif;background:#f8f9fa;color:#212529;}
header{background:#fff;padding:1rem 2rem;border-bottom:1px solid #dee2e6;}
h1{margin:0;font-size:1.5rem;}
.container{display:grid;grid-template-areas:'controls' 'charts';gap:1.5rem;padding:1.5rem;}
#controls{grid-area:controls;display:flex;flex-wrap:wrap;gap:1rem;}
#controls label{font-size:0.9rem;}
#controls input,#controls select{padding:0.4rem 0.6rem;border:1px solid #ced4da;border-radius:4px;}
button#applyFilters{background:#007bff;color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;}
button#applyFilters:hover{background:#0056b3;}
#charts{grid-area:charts;display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;}
.card{background:#fff;padding:1rem;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;}
.modal-content{background:#fff;padding:1.5rem;border-radius:8px;max-height:80vh;overflow-y:auto;width:90%;max-width:600px;}
.modal-content h2{margin-top:0;}
#closeModal{float:right;background:none;border:none;font-size:1.2rem;cursor:pointer;}
@media(min-width:768px){.container{grid-template-areas:'controls controls' 'charts charts';}}
</style>
</head>
<body>
<header><h1>MTN MoMo SMS Transactions Dashboard</h1></header>
<section class="container">
  <div id="controls">
    <label>Date From <input type="date" id="dateFrom"></label>
    <label>Date To <input type="date" id="dateTo"></label>
    <label>Min Amount (RWF) <input type="number" id="amountThreshold" placeholder="0"></label>
    <label>Keyword <input type="text" id="keyword" placeholder="e.g. John"></label>
    <label>Type 
      <select id="typeFilter"><option value="">All Types</option></select>
    </label>
    <button id="applyFilters">Search</button>
  </div>
  <div id="charts">
    <div class="card"><canvas id="barChart"></canvas></div>
    <div class="card"><canvas id="lineChart"></canvas></div>
    <div class="card"><canvas id="pieChart"></canvas></div>
  </div>
</section>

<div class="modal" id="detailModal">
  <div class="modal-content">
    <button id="closeModal">&times;</button>
    <h2>Transactions</h2>
    <ul id="transactionList"></ul>
  </div>
</div>
<script>
const apiBase='/api';
let transactions=[];
let barChart,lineChart,pieChart;

document.addEventListener('DOMContentLoaded',async()=>{
  await loadTransactions();
  document.getElementById('applyFilters').addEventListener('click',applyFilters);
  document.getElementById('closeModal').addEventListener('click',()=>toggleModal(false));
});

async function loadTransactions(){
  try{
    const res=await fetch(`${apiBase}/transactions`);
    if(!res.ok) throw new Error('API unavailable');
    transactions=await res.json();
  }catch(err){
    console.warn('Falling back to sample data',err);
    transactions=sampleData;
  }
  populateTypeDropdown();
  renderCharts(transactions);
}

function populateTypeDropdown(){
  const select=document.getElementById('typeFilter');
  const types=[...new Set(transactions.map(t=>t.type))].sort();
  types.forEach(tp=>{
    const opt=document.createElement('option');opt.value=tp;opt.textContent=tp;select.appendChild(opt);
  });
}

function applyFilters(){
  const from=document.getElementById('dateFrom').value;
  const to=document.getElementById('dateTo').value;
  const minAmt=parseFloat(document.getElementById('amountThreshold').value)||0;
  const kw=document.getElementById('keyword').value.trim().toLowerCase();
  const typeSel=document.getElementById('typeFilter').value;
  const filtered=transactions.filter(tx=>{
    const dateOk=(!from||new Date(tx.date)>=new Date(from))&&(!to||new Date(tx.date)<=new Date(to));
    const amtOk=tx.amount>=minAmt;
    const kwOk=!kw||tx.raw_body.toLowerCase().includes(kw);
    const typeOk=!typeSel||tx.type===typeSel;
    return dateOk&&amtOk&&kwOk&&typeOk;
  });
  renderCharts(filtered);
}

function renderCharts(data){
  const totalsByType={},monthlyTotals={};
  let incoming=0,outgoing=0;
  data.forEach(tx=>{
    totalsByType[tx.type]=(totalsByType[tx.type]||0)+tx.amount;
    const month=tx.date.slice(0,7);
    monthlyTotals[month]=(monthlyTotals[month]||0)+tx.amount;
    tx.direction==='in'?incoming+=tx.amount:outgoing+=tx.amount;
  });
  if(barChart)barChart.destroy();
  if(lineChart)lineChart.destroy();
  if(pieChart)pieChart.destroy();

  const barCtx=document.getElementById('barChart');
  barChart=new Chart(barCtx,{type:'bar',data:{labels:Object.keys(totalsByType),datasets:[{label:'RWF',data:Object.values(totalsByType)}]},options:{plugins:{legend:{display:false}},onClick:(evt)=>{const pts=barChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);if(pts.length){const label=barChart.data.labels[pts[0].index];showDetails(data.filter(tx=>tx.type===label));}}}});

  const lineCtx=document.getElementById('lineChart');
  const months=Object.keys(monthlyTotals).sort();
  lineChart=new Chart(lineCtx,{type:'line',data:{labels:months,datasets:[{label:'Monthly Total (RWF)',data:months.map(m=>monthlyTotals[m]),fill:false}]}});

  const pieCtx=document.getElementById('pieChart');
  pieChart=new Chart(pieCtx,{type:'pie',data:{labels:['Incoming','Outgoing'],datasets:[{data:[incoming,outgoing]}]},options:{onClick:(evt)=>{const pts=pieChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);if(pts.length){const dir=pts[0].index===0?'in':'out';showDetails(data.filter(tx=>tx.direction===dir));}}}});
}

function showDetails(list){
  const ul=document.getElementById('transactionList');
  ul.innerHTML='';
  list.forEach(tx=>{
    const li=document.createElement('li');
    li.textContent=`${tx.date} | ${tx.type} | ${tx.amount} RWF`;
    ul.appendChild(li);
  });
  toggleModal(true);
}

function toggleModal(show){
  document.getElementById('detailModal').style.display=show?'flex':'none';
}

const sampleData=[
  {type:'Incoming Money',amount:5000,date:'2024-01-01',direction:'in',raw_body:'You have received 5000 RWF from John Doe.'},
  {type:'Payments to Code Holders',amount:1500,date:'2024-01-02',direction:'out',raw_body:'Your payment of 1500 RWF to Jane Smith has been completed.'},
  {type:'Airtime Bill Payments',amount:3000,date:'2024-01-03',direction:'out',raw_body:'Your payment of 3000 RWF to Airtime has been completed.'},
  {type:'Withdrawals from Agents',amount:20000,date:'2024-01-04',direction:'out',raw_body:'You have withdrawn 20000 RWF via agent Jane Doe.'},
  {type:'Internet and Voice Bundle Purchurchases',amount:2000,date:'2024-01-05',direction:'out',raw_body:'You purchased an internet bundle of 1GB for 2000 RWF.'}
];
</script>
</body>
</html>
